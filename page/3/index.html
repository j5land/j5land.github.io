<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
	<meta name="generator" content="Hugo 0.110.0">
    
      <meta name="theme" content='FixIt v0.2.17'>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客" /><meta name="keywords" content='J5land, 程序员, 广告行业, 云原生, 这里是 J5land 的博客' /><meta itemprop="name" content="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客">
<meta itemprop="description" content="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"><meta property="og:title" content="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客" />
<meta property="og:description" content="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客" />
<meta property="og:type" content="website" />
<meta property="og:url" content="http://example.org/" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"/>
<meta name="twitter:description" content="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://example.org/" /><link rel="alternate" href="/index.xml" type="application/rss+xml" title="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "WebSite",
    "url": "http:\/\/example.org\/","inLanguage": "zh-CN","description": "J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客","name": "J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/assets/logo.png"
    data-srcset="/assets/logo.png, /assets/logo.png 1.5x, /assets/logo.png 2x"
    data-sizes="auto"
    alt="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"
    title="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"/><span class="header-title-text"></span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/assets/logo.png"
    data-srcset="/assets/logo.png, /assets/logo.png 1.5x, /assets/logo.png 2x"
    data-sizes="auto"
    alt="/assets/logo.png"
    title="/assets/logo.png"/><span class="header-title-text"></span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><div class="page home posts"><div class="home-profile"><div class="home-avatar"><a href="/posts/" title="文章"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png?s=240&amp;d=mp"
    data-srcset="/assets/avatar.png?s=240&amp;d=mp, /assets/avatar.png?s=240&amp;d=mp 1.5x, /assets/avatar.png?s=240&amp;d=mp 2x"
    data-sizes="auto"
    alt="/assets/avatar.png?s=240&amp;d=mp"
    title="/assets/avatar.png?s=240&amp;d=mp"/></a></div><h1 class="home-title">Hi 👋, I'm j5land</h1><h2 class="home-subtitle"><span class="d-none">专注广告技术，喜欢高并发技术，学习K8s/容器技术，期待与大家分享经验，共同学习。</span>
        <span id="typeit-profile-subtitle" class="typeit"></span></h2><div class="links"><a href="https://github.com/j5land" title="GitHub"target="_blank" rel="external nofollow noopener noreferrer me"><i class="fa-brands fa-github-alt fa-fw" aria-hidden="true"></i>
    </a><a href="https://wpa.qq.com/msgrd?v=3&amp;uin=12507149&amp;site=qq&amp;menu=yes" title="QQ"target="_blank" rel="external nofollow noopener noreferrer me"><i data-svg-src="/lib/simple-icons/icons/tencentqq.min.svg" aria-hidden="true"></i>
    </a><a href="mailto:jianghr1@126.com" title="Email" rel=" me"><i class="fa-regular fa-envelope fa-fw" aria-hidden="true"></i>
    </a><a href="/index.xml" title="RSS"target="_blank" rel="external nofollow noopener noreferrer me"><i class="fa-solid fa-rss fa-fw" aria-hidden="true"></i>
    </a></div></div>
<article class="single summary" itemscope itemtype="http://schema.org/Article"><div class="featured-image-preview">
      <a href="/posts/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3hbase%E7%9A%84%E5%AD%98%E5%82%A8%E8%AE%BE%E8%AE%A1%E5%8F%8A%E4%BC%B8%E7%BC%A9%E6%80%A7%E4%B8%8E%E9%AB%98%E5%8F%AF%E7%94%A8/" aria-label="深入了解HBase的存储设计及伸缩性与高可用"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/posts/images/hbase2-1.png"
    data-srcset="/posts/images/hbase2-1.png, /posts/images/hbase2-1.png 1.5x, /posts/images/hbase2-1.png 2x"
    data-sizes="auto"
    alt="/posts/images/hbase2-1.png"
    title="/posts/images/hbase2-1.png"/></a>
    </div><h1 class="single-title" itemprop="name headline">
    <span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><a href="/posts/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3hbase%E7%9A%84%E5%AD%98%E5%82%A8%E8%AE%BE%E8%AE%A1%E5%8F%8A%E4%BC%B8%E7%BC%A9%E6%80%A7%E4%B8%8E%E9%AB%98%E5%8F%AF%E7%94%A8/">深入了解HBase的存储设计及伸缩性与高可用</a>
  </h1><div class="post-meta"><span class="post-author"><span class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c,%20string=%29"
    data-srcset="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 1.5x, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 2x"
    data-sizes="auto"
    alt="j5land"
    title="j5land"/>&nbsp;j5land</span></span>&nbsp;<span class="post-publish" title='2023-03-01 16:00:18'>发布于 <time datetime="2023-03-01">2023-03-01</time></span>&nbsp;<span class="post-category">收录于 <a href="/categories/hbase/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> HBase</a></span></div><div class="content">主要内容 HBase存储设计 HBase读写流程 HBase Campaction（伸缩性） HBase高可用（灾备） HBase存储设计 底层存储 HBase的底</div><div class="post-footer">
    <a href="/posts/%E6%B7%B1%E5%85%A5%E4%BA%86%E8%A7%A3hbase%E7%9A%84%E5%AD%98%E5%82%A8%E8%AE%BE%E8%AE%A1%E5%8F%8A%E4%BC%B8%E7%BC%A9%E6%80%A7%E4%B8%8E%E9%AB%98%E5%8F%AF%E7%94%A8/">阅读全文</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/hbase/' class="post-tag">HBase</a><a href='/tags/nosql/' class="post-tag">NoSQL</a><a href='/tags/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/' class="post-tag">架构设计</a></div></div>
</article>
<article class="single summary" itemscope itemtype="http://schema.org/Article"><div class="featured-image-preview">
      <a href="/posts/%E5%8D%81%E5%88%86%E9%92%9F%E4%BA%86%E8%A7%A3hbase%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%92%8C%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84/" aria-label="十分钟了解Hbase基础概念和存储架构"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/posts/images/hbase-2.png"
    data-srcset="/posts/images/hbase-2.png, /posts/images/hbase-2.png 1.5x, /posts/images/hbase-2.png 2x"
    data-sizes="auto"
    alt="/posts/images/hbase-2.png"
    title="/posts/images/hbase-2.png"/></a>
    </div><h1 class="single-title" itemprop="name headline">
    <span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><a href="/posts/%E5%8D%81%E5%88%86%E9%92%9F%E4%BA%86%E8%A7%A3hbase%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%92%8C%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84/">十分钟了解Hbase基础概念和存储架构</a>
  </h1><div class="post-meta"><span class="post-author"><span class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c,%20string=%29"
    data-srcset="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 1.5x, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 2x"
    data-sizes="auto"
    alt="j5land"
    title="j5land"/>&nbsp;j5land</span></span>&nbsp;<span class="post-publish" title='2023-02-15 16:05:44'>发布于 <time datetime="2023-02-15">2023-02-15</time></span>&nbsp;<span class="post-category">收录于 <a href="/categories/hbase/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> HBase</a></span></div><div class="content">HBase 基础概念和架构 HBase 介绍 HBase 是 BigTable 的开源 Java 版本。是建立在 HDFS 之上，提供高可靠性、高性能、列存储、可伸缩、实时读写 NoSql 的数据库系统。 它介于 NoSql 和 RDBMS 之间，仅</div><div class="post-footer">
    <a href="/posts/%E5%8D%81%E5%88%86%E9%92%9F%E4%BA%86%E8%A7%A3hbase%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E5%92%8C%E5%AD%98%E5%82%A8%E6%9E%B6%E6%9E%84/">阅读全文</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/hbase/' class="post-tag">HBase</a><a href='/tags/nosql/' class="post-tag">NoSQL</a></div></div>
</article>
<article class="single summary" itemscope itemtype="http://schema.org/Article"><div class="featured-image-preview">
      <a href="/posts/%E6%8F%AD%E7%A7%98%E5%B9%BF%E5%91%8A%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" aria-label="揭秘广告架构与系统设计"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/posts/images/%e5%b9%bf%e5%91%8a%e6%b5%81%e7%a8%8b%e5%9b%be.jpg"
    data-srcset="/posts/images/%e5%b9%bf%e5%91%8a%e6%b5%81%e7%a8%8b%e5%9b%be.jpg, /posts/images/%e5%b9%bf%e5%91%8a%e6%b5%81%e7%a8%8b%e5%9b%be.jpg 1.5x, /posts/images/%e5%b9%bf%e5%91%8a%e6%b5%81%e7%a8%8b%e5%9b%be.jpg 2x"
    data-sizes="auto"
    alt="/posts/images/广告流程图.jpg"
    title="/posts/images/广告流程图.jpg"/></a>
    </div><h1 class="single-title" itemprop="name headline">
    <span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><a href="/posts/%E6%8F%AD%E7%A7%98%E5%B9%BF%E5%91%8A%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">揭秘广告架构与系统设计</a>
  </h1><div class="post-meta"><span class="post-author"><span class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c,%20string=%29"
    data-srcset="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 1.5x, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 2x"
    data-sizes="auto"
    alt="j5land"
    title="j5land"/>&nbsp;j5land</span></span>&nbsp;<span class="post-publish" title='2023-02-01 14:28:22'>发布于 <time datetime="2023-02-01">2023-02-01</time></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> 架构设计</a></span></div><div class="content">广告业务 广告、游戏、电商，是互联网企业最主要的盈利业务模式。广告占市场收入份额很大，业务重要性不言而喻。 我们大致从技术角度来看广告业务，广告</div><div class="post-footer">
    <a href="/posts/%E6%8F%AD%E7%A7%98%E5%B9%BF%E5%91%8A%E6%9E%B6%E6%9E%84%E4%B8%8E%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/">阅读全文</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/%E5%B9%BF%E5%91%8A%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/' class="post-tag">广告系统设计</a></div></div>
</article>
<article class="single summary" itemscope itemtype="http://schema.org/Article"><div class="featured-image-preview">
      <a href="/posts/lucene%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86%E5%8F%8A%E8%A7%A3%E6%9E%90/" aria-label="Lucene查询原理及解析"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/posts/images/Lucene.jpeg"
    data-srcset="/posts/images/Lucene.jpeg, /posts/images/Lucene.jpeg 1.5x, /posts/images/Lucene.jpeg 2x"
    data-sizes="auto"
    alt="/posts/images/Lucene.jpeg"
    title="/posts/images/Lucene.jpeg"/></a>
    </div><h1 class="single-title" itemprop="name headline">
    <span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><a href="/posts/lucene%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86%E5%8F%8A%E8%A7%A3%E6%9E%90/">Lucene查询原理及解析</a>
  </h1><div class="post-meta"><span class="post-author"><span class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c,%20string=%29"
    data-srcset="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 1.5x, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 2x"
    data-sizes="auto"
    alt="j5land"
    title="j5land"/>&nbsp;j5land</span></span>&nbsp;<span class="post-publish" title='2023-01-20 14:20:05'>发布于 <time datetime="2023-01-20">2023-01-20</time></span>&nbsp;<span class="post-category">收录于 <a href="/categories/java/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Java</a></span></div><div class="content">前言 Lucene 是一个基于Java的全文信息检索工具包，目前主流的搜索系统Elasticsearch和solr都是基于Lucene的索引和搜索能力进行</div><div class="post-footer">
    <a href="/posts/lucene%E6%9F%A5%E8%AF%A2%E5%8E%9F%E7%90%86%E5%8F%8A%E8%A7%A3%E6%9E%90/">阅读全文</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/lucene/' class="post-tag">Lucene</a><a href='/tags/%E6%A3%80%E7%B4%A2%E5%BC%95%E6%93%8E/' class="post-tag">检索引擎</a></div></div>
</article>
<article class="single summary" itemscope itemtype="http://schema.org/Article"><div class="featured-image-preview">
      <a href="/posts/webclient%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B8%8E%E5%AF%B9%E6%AF%94%E6%B5%8B%E8%AF%95/" aria-label="WebClient性能分析与对比测试"><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="/posts/images/spring_webflux_preview.png"
    data-srcset="/posts/images/spring_webflux_preview.png, /posts/images/spring_webflux_preview.png 1.5x, /posts/images/spring_webflux_preview.png 2x"
    data-sizes="auto"
    alt="/posts/images/spring_webflux_preview.png"
    title="/posts/images/spring_webflux_preview.png"/></a>
    </div><h1 class="single-title" itemprop="name headline">
    <span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><a href="/posts/webclient%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B8%8E%E5%AF%B9%E6%AF%94%E6%B5%8B%E8%AF%95/">WebClient性能分析与对比测试</a>
  </h1><div class="post-meta"><span class="post-author"><span class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c,%20string=%29"
    data-srcset="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 1.5x, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 2x"
    data-sizes="auto"
    alt="j5land"
    title="j5land"/>&nbsp;j5land</span></span>&nbsp;<span class="post-publish" title='2023-01-16 11:51:21'>发布于 <time datetime="2023-01-16">2023-01-16</time></span>&nbsp;<span class="post-category">收录于 <a href="/categories/java/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Java</a></span></div><div class="content"><h1 id="背景">背景</h1>
<p>在Spring 5之前，如果我们想要调用其他系统提供的HTTP服务，我们通常可以使用Spring提供的RestTemplate来访问。RestTemplate用法很简单，但它的不足之处在于它的请求是同步阻塞模式，因此存在一定性能瓶颈，当然如果想要使用异步方式请求，也可以使用AsyncRestTemplate。</p>
<p>从Spring 5开始，Spring中全面引入了Reactive响应式编程，WebClient就属于Spring WebFlux 的一部分。WebClient的请求模式属于异步非阻塞、反应式的，能够以少量固定的线程处理高并发的HTTP 请求。</p>
<p>因此，从Spring 5 开始，HTTP服务之间的通信方式我们可以考虑使用WebCLient来取代之前的RestTemplate。</p>
<h1 id="webclient-详解">WebClient 详解</h1>
<h2 id="webclient特点">WebClient特点</h2>
<p>webClient是一个功能完善的HTTP请求客户端，支持以下内容：</p>
<ul>
<li>非阻塞I/O</li>
<li>反应流回压（即消费者负载过高时，主动反馈生产者放慢速度的机制）</li>
<li>具有高并发性，硬件资源消耗更少</li>
<li>流程的API设计</li>
<li>同步与异步交互</li>
<li>流式传输支持</li>
</ul>
<h1 id="webclient-开发配置">WebClient 开发配置</h1>
<h2 id="1-添加依赖">1 添加依赖</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-webflux<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h2 id="2-基础配置">2 基础配置</h2>
<p>WebClient 实例构造器可以设置一些基础的全局web请求配置信息，比如默认的cookie、header、baseUrl等。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">defaultCookie</span><span class="o">(</span><span class="s">&#34;kl&#34;</span><span class="o">,</span><span class="s">&#34;kl&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">defaultUriVariables</span><span class="o">(</span><span class="n">ImmutableMap</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span><span class="s">&#34;kl&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">defaultHeader</span><span class="o">(</span><span class="s">&#34;header&#34;</span><span class="o">,</span><span class="s">&#34;kl&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">defaultHeaders</span><span class="o">(</span><span class="n">httpHeaders</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">httpHeaders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;header1&#34;</span><span class="o">,</span><span class="s">&#34;kl&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">httpHeaders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;header2&#34;</span><span class="o">,</span><span class="s">&#34;kl&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">})</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">defaultCookies</span><span class="o">(</span><span class="n">cookie</span> <span class="o">-&gt;{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cookie</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;cookie1&#34;</span><span class="o">,</span><span class="s">&#34;kl&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                    <span class="n">cookie</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;cookie2&#34;</span><span class="o">,</span><span class="s">&#34;kl&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                <span class="o">})</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">&#34;http://www.compay.com&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span></code></pre></div><h2 id="3-底层依赖netty库配置">3 底层依赖Netty库配置</h2>
<p>通过配置Netty底层库，可以配置SSL安全链接、请求超时、读写超时等。</p>
<p>可以通过配置动态连接池，自定义突破这些默认配置。包括Netty的select线程和工作线程也可以自己设置。</p>
<ul>
<li>最大连接数（maxConnections）：ConnectionProvider连接池的最大连接数选项，默认为<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/resources/ConnectionProvider.html#DEFAULT_POOL_MAX_CONNECTIONS"target="_blank" rel="external nofollow noopener noreferrer"><code>ConnectionProvider.DEFAULT_POOL_MAX_CONNECTIONS</code></a>，即：2 * 可用处理器数（但最小值为 16），<a href="https://github.com/reactor/reactor-netty/issues/2052"target="_blank" rel="external nofollow noopener noreferrer">#2052</a>
<ul>
<li>Reactor Netty 提供了两种创建客户端的方式
<ul>
<li><code>HttpClient.create()</code>- 这使用<strong>预定义</strong> <code>ConnectionProvider</code>的，它是这样创建的<code>ConnectionProvider.create(name, 500)</code>。这意味着<code>500</code> <code>maxConnections</code>（这是在构建器中明确指定的<code>ConnectionProvider</code>）和<code>1000</code> <code>pendingAcquireMaxCount</code>（这是<code>ConnectionProvider</code>构建器提供的默认值）</li>
<li><code>HttpClient.create(ConnectionProvider)</code>- 用户提供自定义<code>ConnectionProvider</code></li>
<li>JavaDoc：https://projectreactor.io/docs/netty/release/api/reactor/netty/resources/ConnectionProvider.ConnectionPoolSpec.html#maxConnections-int-</li>
</ul>
</li>
</ul>
</li>
<li>最大空闲时间（maxIdleTime）：默认<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/resources/ConnectionProvider.html#DEFAULT_POOL_MAX_IDLE_TIME"target="_blank" rel="external nofollow noopener noreferrer"><code>ConnectionProvider.DEFAULT_POOL_MAX_IDLE_TIME</code></a>，默认无空闲时间</li>
<li>最大存活时间（maxLifeTime）：默认<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/resources/ConnectionProvider.html#DEFAULT_POOL_MAX_LIFE_TIME"target="_blank" rel="external nofollow noopener noreferrer"><code>ConnectionProvider.DEFAULT_POOL_MAX_LIFE_TIME</code></a></li>
<li>等待获取时间（pendingAcquireTimeout）：获取连接超时默认45000ms，即45秒</li>
<li>挂起的获取最大计数（pendingAcquireMaxCount）：获取的最大注册请求数以保留在挂起队列中当使用 -1 调用时，挂起队列将没有上限。默认为<code>2 * max connections</code>.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//最大连接数、最大空闲时间、最大存活时间、获取连接超时时间
</span></span></span><span class="line"><span class="cl"><span class="c1">//挂起的获取最大计数
</span></span></span><span class="line"><span class="cl"><span class="c1">//在后台被驱逐时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ConnectionProvider</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">ConnectionProvider</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">&#34;fixed&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">maxConnections</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">maxIdleTime</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">maxLifeTime</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">pendingAcquireTimeout</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">pendingAcquireMaxCount</span><span class="o">(</span><span class="mi">20000</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">evictInBackground</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">120</span><span class="o">)).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//配置Netty select线程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">HttpClient</span> <span class="n">httpClient</span> <span class="o">=</span> <span class="n">HttpClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">provider</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  							<span class="o">.</span><span class="na">tcpConfiguration</span><span class="o">(</span><span class="n">tcpClient</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                     <span class="c1">//指定Netty的select 和 work线程数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                     <span class="n">LoopResources</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">LoopResources</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&#34;kl-event-loop&#34;</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                     <span class="k">return</span> <span class="n">tcpClient</span><span class="o">.</span><span class="na">doOnConnected</span><span class="o">(</span><span class="n">connection</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                         <span class="c1">//读写超时设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                         <span class="n">connection</span><span class="o">.</span><span class="na">addHandlerLast</span><span class="o">(</span><span class="k">new</span> <span class="n">ReadTimeoutHandler</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                                 <span class="o">.</span><span class="na">addHandlerLast</span><span class="o">(</span><span class="k">new</span> <span class="n">WriteTimeoutHandler</span><span class="o">(</span><span class="mi">10</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">                     <span class="o">})</span>
</span></span><span class="line"><span class="cl">                       <span class="c1">//连接超时设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">CONNECT_TIMEOUT_MILLIS</span><span class="o">,</span> <span class="mi">10000</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">.</span><span class="na">option</span><span class="o">(</span><span class="n">ChannelOption</span><span class="o">.</span><span class="na">TCP_NODELAY</span><span class="o">,</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                       <span class="o">.</span><span class="na">runOn</span><span class="o">(</span><span class="n">loop</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">                 <span class="o">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">clientConnector</span><span class="o">(</span><span class="k">new</span> <span class="n">ReactorClientHttpConnector</span><span class="o">(</span><span class="n">httpClient</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span></code></pre></div><h3 id="webclient-使用上常见问题">WebClient 使用上常见问题</h3>
<h4 id="1-poolacquirependinglimitexception">1 PoolAcquirePendingLimitException</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Pending</span> <span class="n">acquire</span> <span class="n">queue</span> <span class="n">has</span> <span class="n">reached</span> <span class="n">its</span> <span class="n">maximum</span> <span class="n">size</span> <span class="n">of</span> <span class="mi">1000</span><span class="o">;</span> <span class="n">nested</span> <span class="n">exception</span> <span class="n">is</span> <span class="n">reactor</span><span class="o">.</span><span class="na">netty</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">shaded</span><span class="o">.</span><span class="na">reactor</span><span class="o">.</span><span class="na">pool</span><span class="o">.</span><span class="na">PoolAcquirePendingLimitException</span><span class="o">:</span> <span class="n">Pending</span> <span class="n">acquire</span> <span class="n">queue</span> <span class="n">has</span> <span class="n">reached</span> <span class="n">its</span> <span class="n">maximum</span> <span class="n">size</span> <span class="n">of</span> <span class="mi">1000</span>
</span></span></code></pre></div><p>WebClient需要一个HTTP客户端库来执行请求。
默认情况下，它使用Reactor Netty，客户端使用一个“固定”连接池，其中500个是活动通道的最大数量，1000个是允许保持在挂起状态的进一步通道获取尝试的最大数量。</p>
<p>只要创建的通道少于500个，并且由池管理，那么实现就会创建一个新通道。
当达到池中通道的最大数量时，最多会延迟（挂起）1000次获取通道的新尝试，直到通道再次返回到池中，并且会拒绝进一步尝试，并出现错误。</p>
<p><strong>你有两个选择来解决这个问题，垂直扩展：增加连接池大小和/或获取队列长度，水平扩展：创建应用程序的其他实例。</strong></p>
<p>1.1 垂直扩展：增加连接池大小和/或获取队列长度</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">ConnectionProvider</span> <span class="n">connectionProvider</span> <span class="o">=</span> <span class="n">ConnectionProvider</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">&#34;myConnectionPool&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">maxConnections</span><span class="o">(&lt;</span><span class="n">your_desired_max_connections</span><span class="o">&gt;)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">pendingAcquireMaxCount</span><span class="o">(&lt;</span><span class="n">your_desired_pending_queue_size</span><span class="o">&gt;)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">ReactorClientHttpConnector</span> <span class="n">clientHttpConnector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReactorClientHttpConnector</span><span class="o">(</span><span class="n">HttpClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">connectionProvider</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="n">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">clientConnector</span><span class="o">(</span><span class="n">clientHttpConnector</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span></code></pre></div><p>1.2 水平扩展：创建应用程序的其他实例，并在实例之间平衡api调用的负载。
在计算连接池的大小时，值得考虑下游api调用的延迟。
<code>connection_pool_size=tps * downstream_api_latency</code>
<code>tps（每秒事务数）</code></p>
<h3 id="2-connection-reset-by-peer-exception">2 Connection reset by peer exception</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">Connection</span> <span class="n">reset</span> <span class="n">by</span> <span class="n">peer</span> <span class="n">exception</span>
</span></span></code></pre></div><p>由于没有设置合理的连接池抛出的异常信息。</p>
<p><a href="https://github.com/reactor/reactor-netty/issues/1774"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/reactor/reactor-netty/issues/1774</a></p>
<h1 id="构建http请求示例">构建HTTP请求示例</h1>
<h2 id="1-get请求示例">1 GET请求示例</h2>
<p>URI构造时支持属性占位符，真实参数在入参时排序好就可以。同时可以通过accept设置媒体类型，以及编码。最终的结果值是通过Mono和Flux来接收的，在subscribe方法中订阅返回值。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">WebClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">WebClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&#34;http://www.compay.com&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">get</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;/book/{id}.html&#34;</span><span class="o">,</span> <span class="mi">123</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">acceptCharset</span><span class="o">(</span><span class="n">StandardCharsets</span><span class="o">.</span><span class="na">UTF_8</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">TEXT_HTML</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span></code></pre></div><p>如果需要携带复杂的查询参数，可以通过UriComponentsBuilder构造出URL请求地址，如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="c1">//定义query参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">MultiValueMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">params</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedMultiValueMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">params</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span> <span class="s">&#34;daybreak&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//定义url参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">uriVariables</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="n">uriVariables</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;id&#34;</span><span class="o">,</span> <span class="mi">200</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">uri</span> <span class="o">=</span> <span class="n">UriComponentsBuilder</span><span class="o">.</span><span class="na">fromUriString</span><span class="o">(</span><span class="s">&#34;/book/{id}.html&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">queryParams</span><span class="o">(</span><span class="n">params</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">uriVariables</span><span class="o">(</span><span class="n">uriVariables</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">toUriString</span><span class="o">();</span>
</span></span></code></pre></div><h2 id="2-post请求示例">2 POST请求示例</h2>
<p>POST请求示例演示了一个同时包含表单参数和文件流数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">WebClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">WebClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&#34;http://www.compay.com&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">FormInserter</span> <span class="n">formInserter</span> <span class="o">=</span> <span class="n">fromMultipartData</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span><span class="s">&#34;daybreak&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;map&#34;</span><span class="o">,</span><span class="n">ImmutableMap</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;xx&#34;</span><span class="o">,</span><span class="s">&#34;xx&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&#34;file&#34;</span><span class="o">,</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&#34;d://xxx.doc&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">post</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;/book/{id}.html&#34;</span><span class="o">,</span> <span class="mi">123</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">formInserter</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span></code></pre></div><p>普通POST请求，直接通过bodyValue设置对象实例即可。不用FormInserter构造</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">WebClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">WebClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&#34;http://www.compay.com&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">post</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;/book/{id}.html&#34;</span><span class="o">,</span> <span class="mi">123</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">contentType</span><span class="o">(</span><span class="n">MediaType</span><span class="o">.</span><span class="na">APPLICATION_JSON</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">.</span><span class="na">bodyValue</span><span class="o">(</span><span class="n">ImmutableMap</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">&#34;name&#34;</span><span class="o">,</span><span class="s">&#34;daybreak&#34;</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span><span class="o">.</span><span class="na">subscribe</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>
</span></span></code></pre></div><h2 id="3-同步返回结果">3 同步返回结果</h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">WebClient</span> <span class="n">client</span> <span class="o">=</span>  <span class="n">WebClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&#34;http://www.compay.com&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">client</span> <span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;/book/{id}.html&#34;</span><span class="o">,</span> <span class="mi">123</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">retrieve</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">.</span><span class="na">block</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">result</span><span class="o">);</span>
</span></span></code></pre></div><h2 id="4-异常处理">4 异常处理</h2>
<p>可以使用OnStatus根据status code进行异常适配。</p>
<p>可以使用doOnError异常适配</p>
<p>可以使用onErrorReturn返回指定默认返回值</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">WebClient</span> <span class="n">webClient</span> <span class="o">=</span> <span class="n">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">baseUrl</span><span class="o">(</span><span class="s">&#34;https://api.compay.com&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">defaultHeader</span><span class="o">(</span><span class="n">HttpHeaders</span><span class="o">.</span><span class="na">CONTENT_TYPE</span><span class="o">,</span> <span class="s">&#34;application/json&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">defaultHeader</span><span class="o">(</span><span class="n">HttpHeaders</span><span class="o">.</span><span class="na">USER_AGENT</span><span class="o">,</span> <span class="s">&#34;Spring 5 WebClient&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">WebClient</span><span class="o">.</span><span class="na">ResponseSpec</span> <span class="n">responseSpec</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">method</span><span class="o">(</span><span class="n">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">uri</span><span class="o">(</span><span class="s">&#34;/user/list?sort={sortField}&#34;</span><span class="o">,</span> <span class="s">&#34;updated&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">retrieve</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">Mono</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">mono</span> <span class="o">=</span> <span class="n">responseSpec</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">onStatus</span><span class="o">(</span><span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">.</span><span class="na">is4xxClientError</span><span class="o">(),</span><span class="n">resp</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">&#34;error:{},msg:{}&#34;</span><span class="o">,</span><span class="n">resp</span><span class="o">.</span><span class="na">statusCode</span><span class="o">().</span><span class="na">value</span><span class="o">(),</span><span class="n">resp</span><span class="o">.</span><span class="na">statusCode</span><span class="o">().</span><span class="na">getReasonPhrase</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">Mono</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">resp</span><span class="o">.</span><span class="na">statusCode</span><span class="o">().</span><span class="na">value</span><span class="o">()</span> <span class="o">+</span> <span class="s">&#34; : &#34;</span> <span class="o">+</span> <span class="n">resp</span><span class="o">.</span><span class="na">statusCode</span><span class="o">().</span><span class="na">getReasonPhrase</span><span class="o">()));</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">bodyToMono</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">doOnError</span><span class="o">(</span><span class="n">WebClientResponseException</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">err</span> <span class="o">-&gt;</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;ERROR status:{},msg:{}&#34;</span><span class="o">,</span><span class="n">err</span><span class="o">.</span><span class="na">getRawStatusCode</span><span class="o">(),</span><span class="n">err</span><span class="o">.</span><span class="na">getResponseBodyAsString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="n">err</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="o">})</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span><span class="na">onErrorReturn</span><span class="o">(</span><span class="s">&#34;fallback&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">mono</span><span class="o">.</span><span class="na">block</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;result:{}&#34;</span><span class="o">,</span><span class="n">result</span><span class="o">);</span>
</span></span></code></pre></div><h1 id="性能对比测试">性能对比测试</h1>
<p>接下来我们进行性能对比测试。</p>
<p>在某个业务场景中我们使用了RestTemplate，借此分析下WebClient 与 RestTemplate 两者的性能实际表现，通过实际的案例性能对比，看看WebClient 是否有如此优秀。</p>
<h2 id="业务场景说明">业务场景说明</h2>
<p>在我们的业务场景中，是一个异步处理的场景。当完成某项业务后，进行HTTP异步通知处理。这个也是在业务开发中比较场景的一种场景。</p>
<h2 id="测试方案设计">测试方案设计</h2>
<h3 id="延迟的负载测试分析">延迟的负载测试分析</h3>
<p>搭建待测试项目</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">AtomicInteger</span> <span class="n">metrics</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicInteger</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&#34;/check&#34;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@ResponseBody</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">check</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100L</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="s">&#34;success_&#34;</span> <span class="o">+</span> <span class="n">metrics</span><span class="o">.</span><span class="na">incrementAndGet</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h3 id="caller设计">Caller设计</h3>
<p>1 ThreadPoolTaskExecutor + RestTemplate</p>
<p>通过线程组组合 RestTemplate 实现异步HTTP请求。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">		<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">poolSize</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">(),</span> <span class="mi">8</span><span class="o">)</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">queueSize</span> <span class="o">=</span> <span class="mi">20000</span><span class="o">;</span>	
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">		<span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">TaskExecutor</span> <span class="nf">listenerExecutor</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadPoolTaskExecutor</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPoolTaskExecutor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="n">poolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="n">poolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setQueueCapacity</span><span class="o">(</span><span class="n">queueSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setRejectedExecutionHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">.</span><span class="na">CallerRunsPolicy</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setWaitForTasksToCompleteOnShutdown</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setAwaitTerminationSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">pool</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><ul>
<li>corePoolSize：Math.max(Runtime.getRuntime().availableProcessors(), 8) * 2</li>
<li>maxPoolSize：Math.max(Runtime.getRuntime().availableProcessors(), 8) * 2</li>
<li>queueCapacity：20000</li>
<li>rejectedExecutionHandler：CallerRunsPolicy</li>
</ul>
<p>2 AsyncRestTemplate</p>
<p>原官方的线程组+RestTemplate方法，在Spring5.0以及废弃，替换换WebClient。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">		<span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">AsyncRestTemplate</span> <span class="nf">asyncRestTemplate</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">SimpleClientHttpRequestFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleClientHttpRequestFactory</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">factory</span><span class="o">.</span><span class="na">setConnectTimeout</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">factory</span><span class="o">.</span><span class="na">setReadTimeout</span><span class="o">(</span><span class="mi">200</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">ThreadPoolTaskExecutor</span> <span class="n">pool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPoolTaskExecutor</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">poolSize</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">availableProcessors</span><span class="o">(),</span> <span class="mi">8</span><span class="o">)</span> <span class="o">*</span> <span class="mi">2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setCorePoolSize</span><span class="o">(</span><span class="n">poolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setMaxPoolSize</span><span class="o">(</span><span class="n">poolSize</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setQueueCapacity</span><span class="o">(</span><span class="mi">20000</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setRejectedExecutionHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">.</span><span class="na">CallerRunsPolicy</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setWaitForTasksToCompleteOnShutdown</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">setAwaitTerminationSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">pool</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">factory</span><span class="o">.</span><span class="na">setTaskExecutor</span><span class="o">(</span><span class="n">pool</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="k">new</span> <span class="n">AsyncRestTemplate</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><ul>
<li>corePoolSize：Math.max(Runtime.getRuntime().availableProcessors(), 8) * 2</li>
<li>maxPoolSize：Math.max(Runtime.getRuntime().availableProcessors(), 8) * 2</li>
<li>queueCapacity：20000</li>
<li>rejectedExecutionHandler：CallerRunsPolicy</li>
</ul>
<p>WebClient：异步非阻塞、反应式的，能够以少量固定的线程处理高并发的HTTP 请求。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">		<span class="nd">@Bean</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">WebClient</span> <span class="nf">webClient</span><span class="o">(){</span>
</span></span><span class="line"><span class="cl">        <span class="n">ConnectionProvider</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">ConnectionProvider</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">&#34;fixed&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">maxConnections</span><span class="o">(</span><span class="mi">200</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">maxIdleTime</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">maxLifeTime</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">pendingAcquireTimeout</span><span class="o">(</span><span class="n">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">))</span>
</span></span><span class="line"><span class="cl">                <span class="o">.</span><span class="na">pendingAcquireMaxCount</span><span class="o">(</span><span class="mi">1000</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">WebClient</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">clientConnector</span><span class="o">(</span><span class="k">new</span> <span class="n">ReactorClientHttpConnector</span><span class="o">(</span><span class="n">HttpClient</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">provider</span><span class="o">))).</span><span class="na">build</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><ul>
<li>最大连接数（maxConnections）：200</li>
<li>最大空闲时间（maxIdleTime）：60s</li>
<li>最大存活时间（maxLifeTime）：60s</li>
<li>等待获取时间（pendingAcquireTimeout）：60s</li>
<li>挂起的获取最大计数（pendingAcquireMaxCount）：1000</li>
</ul>
<h2 id="测试结果分析">测试结果分析</h2>
<h3 id="1-threadpooltaskexecutor--resttemplate">1 ThreadPoolTaskExecutor + RestTemplate</h3>
<table>
<thead>
<tr>
<th style="text-align:center">用户量</th>
<th style="text-align:center">线程数</th>
<th>吞吐量(req/sec)</th>
<th>95%(ms)</th>
<th>延迟完成(min)</th>
<th>堆内存(Mb)</th>
<th>CPU占用率</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">100</td>
<td style="text-align:center">44</td>
<td>168</td>
<td>1</td>
<td>0</td>
<td>100</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center">200</td>
<td style="text-align:center">42</td>
<td>334</td>
<td>1</td>
<td>1</td>
<td>100</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center">400</td>
<td style="text-align:center">92</td>
<td>602</td>
<td>115</td>
<td>1</td>
<td>100</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center">800</td>
<td style="text-align:center">232</td>
<td>972</td>
<td>533</td>
<td>2</td>
<td>100</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center">1200</td>
<td style="text-align:center">232</td>
<td>1007</td>
<td>1175</td>
<td>2</td>
<td>150</td>
<td>4</td>
</tr>
<tr>
<td style="text-align:center">1600</td>
<td style="text-align:center">232</td>
<td>1003</td>
<td>1683</td>
<td>3</td>
<td>200</td>
<td>5</td>
</tr>
</tbody>
</table>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="../images/resttemplate.jpg"
    data-srcset="../images/resttemplate.jpg, ../images/resttemplate.jpg 1.5x, ../images/resttemplate.jpg 2x"
    data-sizes="auto"
    alt="resttemplate"
    title="resttemplate"/></p>
<h3 id="2-asyncresttemplate">2 AsyncRestTemplate</h3>
<table>
<thead>
<tr>
<th style="text-align:center">用户量</th>
<th style="text-align:center">线程数</th>
<th>吞吐量(req/sec)</th>
<th>95%(ms)</th>
<th>延迟完成(min)</th>
<th>堆内存(Mb)</th>
<th>CPU占用率</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">100</td>
<td style="text-align:center">47</td>
<td>168</td>
<td>1</td>
<td>0</td>
<td>200</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center">200</td>
<td style="text-align:center">37</td>
<td>334</td>
<td>1</td>
<td>2</td>
<td>300-500</td>
<td>3</td>
</tr>
<tr>
<td style="text-align:center">400</td>
<td style="text-align:center">93</td>
<td>603</td>
<td>111</td>
<td>3</td>
<td>400-500</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center">800</td>
<td style="text-align:center">169</td>
<td>981</td>
<td>127</td>
<td>3</td>
<td>1000</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center">1200</td>
<td style="text-align:center">235</td>
<td>1633</td>
<td>215</td>
<td>3</td>
<td>1000</td>
<td>5</td>
</tr>
<tr>
<td style="text-align:center">1600</td>
<td style="text-align:center">235</td>
<td>1869</td>
<td>417</td>
<td>3</td>
<td>1000</td>
<td>5</td>
</tr>
</tbody>
</table>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="../images/async-resttemplate2.jpg"
    data-srcset="../images/async-resttemplate2.jpg, ../images/async-resttemplate2.jpg 1.5x, ../images/async-resttemplate2.jpg 2x"
    data-sizes="auto"
    alt="async-resttemplate2"
    title="async-resttemplate2"/></p>
<h3 id="3-webclient">3 Webclient</h3>
<table>
<thead>
<tr>
<th>用户量</th>
<th>线程数</th>
<th>吞吐量(req/sec)</th>
<th>95%(ms)</th>
<th>延迟完成(min)</th>
<th>堆内存(Mb)</th>
<th>CPU占用率</th>
<th style="text-align:center">信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>100</td>
<td>38</td>
<td>168</td>
<td>1</td>
<td>0</td>
<td>100</td>
<td>2</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>200</td>
<td>37</td>
<td>335</td>
<td>1</td>
<td>0</td>
<td>100</td>
<td>2</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>400</td>
<td>37</td>
<td>667</td>
<td>1</td>
<td>0</td>
<td>100</td>
<td>2</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>800</td>
<td>43</td>
<td>1334</td>
<td>1</td>
<td>0</td>
<td>100</td>
<td>3</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>1200</td>
<td>50</td>
<td>2000</td>
<td>1</td>
<td>0</td>
<td>110</td>
<td>4</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>1400</td>
<td>43</td>
<td>2326</td>
<td>1</td>
<td>0</td>
<td>120</td>
<td>5</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td>1600</td>
<td>51</td>
<td>2632</td>
<td>1</td>
<td>0</td>
<td>130</td>
<td>5</td>
<td style="text-align:center">PoolAcquirePendingLimitException</td>
</tr>
<tr>
<td>1800</td>
<td>44</td>
<td>3031</td>
<td>1</td>
<td>0</td>
<td>150</td>
<td>6</td>
<td style="text-align:center">PoolAcquirePendingLimitException</td>
</tr>
<tr>
<td>2000</td>
<td>48</td>
<td>3334</td>
<td>1</td>
<td>0</td>
<td>200</td>
<td>7</td>
<td style="text-align:center">PoolAcquirePendingLimitException</td>
</tr>
<tr>
<td>2400</td>
<td>51</td>
<td>4000</td>
<td>1</td>
<td>0</td>
<td>250</td>
<td>8</td>
<td style="text-align:center">PoolAcquirePendingLimitException</td>
</tr>
<tr>
<td>3000</td>
<td>54</td>
<td>4994</td>
<td>1</td>
<td>0</td>
<td>500</td>
<td>10</td>
<td style="text-align:center">PoolAcquirePendingLimitException</td>
</tr>
<tr>
<td>4000</td>
<td>83</td>
<td>6666</td>
<td>1</td>
<td>0</td>
<td>800</td>
<td>15</td>
<td style="text-align:center">PoolAcquirePendingLimitException</td>
</tr>
<tr>
<td>5000</td>
<td>130</td>
<td>8308</td>
<td>1</td>
<td>0</td>
<td>1000</td>
<td>20</td>
<td style="text-align:center">PoolAcquirePendingLimitException</td>
</tr>
</tbody>
</table>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="../images/webclient2.jpg"
    data-srcset="../images/webclient2.jpg, ../images/webclient2.jpg 1.5x, ../images/webclient2.jpg 2x"
    data-sizes="auto"
    alt="webclient2"
    title="webclient2"/></p>
<p><img
    class="lazyload"
    src="/svg/loading.min.svg"
    data-src="../images/image-20230116151614439.png"
    data-srcset="../images/image-20230116151614439.png, ../images/image-20230116151614439.png 1.5x, ../images/image-20230116151614439.png 2x"
    data-sizes="auto"
    alt="image-20230116151614439"
    title="image-20230116151614439"/></p>
<h3 id="压测结论">压测结论</h3>
<p>1.ThreadPoolTaskExecutor + RestTemplate，用户并发量在800，吞吐量可以达到972/s，但是tomcat线程被打满，已经出现了延迟等待的现象（由于使用的是CallerRunsPolicy策略）。</p>
<p>2.AsyncRestTemplate，用户并发量在800，吞吐量981/s，线程数169基本也进入CallerRunsPolicy策略。</p>
<p>3.Webclient，用户并发量在1400，吞吐量2326/s，线程数、内存、cpu都相对问题，由于Webclient是异步非阻塞的，不能像线程池一样设置执行CallerRunsPolicy策略，当用户并发量1600达到性能瓶颈，开始触发PoolAcquirePendingLimitException异常，Webclient的弊端在业务的做好容量规划，做好对应的垂直、水平扩展以及失败情况的fallback。</p>
<h1 id="总结">总结</h1>
<p>WebClient性能非常优异，同样能够以少量而固定的线程数处理高并发的Http请求，在基于Http的服务间通信方面，完全可以取代RestTemplate以及AsyncRestTemplate。</p>
<p>参考：</p>
<ul>
<li><a href="https://blog.51cto.com/liukang/2090211"target="_blank" rel="external nofollow noopener noreferrer">https://blog.51cto.com/liukang/2090211</a></li>
<li><a href="https://projectreactor.io/docs/netty/snapshot/reference/index.html#_connection_pool_2"target="_blank" rel="external nofollow noopener noreferrer">https://projectreactor.io/docs/netty/snapshot/reference/index.html#_connection_pool_2</a></li>
</ul></div><div class="post-footer">
    <a href="/posts/webclient%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E4%B8%8E%E5%AF%B9%E6%AF%94%E6%B5%8B%E8%AF%95/">阅读全文</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/webclient/' class="post-tag">webclient</a><a href='/tags/java/' class="post-tag">Java</a><a href='/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/' class="post-tag">性能分析</a></div></div>
</article>
<article class="single summary" itemscope itemtype="http://schema.org/Article"><h1 class="single-title" itemprop="name headline">
    <span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><a href="/posts/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">单元测试最佳实践</a>
  </h1><div class="post-meta"><span class="post-author"><span class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c,%20string=%29"
    data-srcset="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 1.5x, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 2x"
    data-sizes="auto"
    alt="j5land"
    title="j5land"/>&nbsp;j5land</span></span>&nbsp;<span class="post-publish" title='2022-11-21 14:02:25'>发布于 <time datetime="2022-11-21">2022-11-21</time></span>&nbsp;<span class="post-category">收录于 <a href="/categories/java/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Java</a></span></div><div class="content">背景 在近期的代码重构的过程中，遇到各式各样的问题，比如调整代码顺序导致的bug，方法重构参数校验逻辑的移除等。 在上线前需要花大量时间进行测试</div><div class="post-footer">
    <a href="/posts/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">阅读全文</a><div class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/' class="post-tag">单元测试</a><a href='/tags/mockito/' class="post-tag">Mockito</a></div></div>
</article>
<ul class="pagination"><li class="page-item">
          <span class="page-link">
            <a href="/">1</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/2/">2</a>
          </span>
        </li><li class="page-item active">
          <span class="page-link">
            <a href="/page/3/">3</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/4/">4</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/5/">5</a>
          </span>
        </li><li class="page-item">
          <span class="page-link">
            <a href="/page/6/">6</a>
          </span>
        </li></ul></div></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Copyright © J5land Blog 2023
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中 ...</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="/lib/typeit/index.umd.js" defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"data":{"typeit-profile-subtitle":"专注广告技术，喜欢高并发技术，学习K8s/容器技术，期待与大家分享经验，共同学习。"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":30,"threshold":0.3,"useExtendedSearch":false},"siteTime":"2020-05-23T16:15:22+08:00","typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"typeit-profile-subtitle":["typeit-profile-subtitle"]},"duration":-1,"speed":100}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
