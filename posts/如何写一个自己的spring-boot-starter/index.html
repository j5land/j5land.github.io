<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>如何写一个自己的Spring Boot Starter - J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="背景 我们知道可以使用SpringBoot快速开发基于Spring框架的项目，由于围绕SpringBoot存在很多开箱即用的Starter依赖" /><meta name="keywords" content='Java, SpringBoot' /><meta itemprop="name" content="如何写一个自己的Spring Boot Starter">
<meta itemprop="description" content="背景 我们知道可以使用SpringBoot快速开发基于Spring框架的项目，由于围绕SpringBoot存在很多开箱即用的Starter依赖"><meta itemprop="datePublished" content="2022-06-12T14:10:04+08:00" />
<meta itemprop="dateModified" content="2022-06-12T14:10:04+08:00" />
<meta itemprop="wordCount" content="2418">
<meta itemprop="keywords" content="Java,SpringBoot," /><meta property="og:title" content="如何写一个自己的Spring Boot Starter" />
<meta property="og:description" content="背景 我们知道可以使用SpringBoot快速开发基于Spring框架的项目，由于围绕SpringBoot存在很多开箱即用的Starter依赖" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AA%E8%87%AA%E5%B7%B1%E7%9A%84spring-boot-starter/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-12T14:10:04+08:00" />
<meta property="article:modified_time" content="2022-06-12T14:10:04+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何写一个自己的Spring Boot Starter"/>
<meta name="twitter:description" content="背景 我们知道可以使用SpringBoot快速开发基于Spring框架的项目，由于围绕SpringBoot存在很多开箱即用的Starter依赖"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://example.org/posts/%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AA%E8%87%AA%E5%B7%B1%E7%9A%84spring-boot-starter/" /><link rel="prev" href="http://example.org/posts/springboot%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/" /><link rel="next" href="http://example.org/posts/mysql%E4%BA%8B%E5%8A%A1%E4%B8%8Espring%E4%BA%8B%E5%8A%A1%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "如何写一个自己的Spring Boot Starter",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/example.org\/posts\/%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AA%E8%87%AA%E5%B7%B1%E7%9A%84spring-boot-starter\/"
    },"genre": "posts","keywords": "Java, SpringBoot","wordcount":  2418 ,
    "url": "http:\/\/example.org\/posts\/%E5%A6%82%E4%BD%95%E5%86%99%E4%B8%80%E4%B8%AA%E8%87%AA%E5%B7%B1%E7%9A%84spring-boot-starter\/","datePublished": "2022-06-12T14:10:04+08:00","dateModified": "2022-06-12T14:10:04+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "j5land"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png"
    data-srcset="/assets/avatar.png, /assets/avatar.png 1.5x, /assets/avatar.png 2x"
    data-sizes="auto"
    alt="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"
    title="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"/><span class="header-title-text">这里是 J5land 的博客</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li>
      </ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="J5land, 程序员, 广告行业, 云原生 | 这里是 J5land 的博客"><img
    class="lazyload logo"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png"
    data-srcset="/assets/avatar.png, /assets/avatar.png 1.5x, /assets/avatar.png 2x"
    data-sizes="auto"
    alt="/assets/avatar.png"
    title="/assets/avatar.png"/><span class="header-title-text">这里是 J5land 的博客</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容 ..." id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> 文章</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> 分类</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> 标签</a></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container" data-page-style="normal"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX">
        <span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>如何写一个自己的Spring Boot Starter</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><img
    class="lazyload avatar"
    src="/svg/loading.min.svg"
    data-src="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c,%20string=%29"
    data-srcset="/assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 1.5x, /assets/avatar.png?s=32&amp;d=localhost:1313%25!%28EXTRA%20string=09f6ba2c1a27e4f0245271e28bf8417c%2c%20string=%29 2x"
    data-sizes="auto"
    alt="j5land"
    title="j5land"/>&nbsp;j5land</span></span>
          <span class="post-category">收录于 <a href="/categories/java/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Java</a></span></div>
      <div class="post-meta-line"><span title=2022-06-12&#32;14:10:04><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2022-06-12">2022-06-12</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i> 约 2418 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden="true"></i> 预计阅读 5 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#原理">原理</a>
      <ul>
        <li><a href="#官方说明">官方说明</a></li>
        <li><a href="#conditional">@Conditional</a></li>
      </ul>
    </li>
    <li><a href="#实现步骤">实现步骤</a>
      <ul>
        <li><a href="#第一步命名与分模块">第一步：命名与分模块</a></li>
        <li><a href="#starter模块">Starter模块</a></li>
        <li><a href="#第二步编写autoconfigure模块">第二步：编写AutoConfigure模块</a></li>
        <li><a href="#自定义service">自定义Service</a></li>
        <li><a href="#第三步配置springfactories">第三步：配置spring.factories</a></li>
        <li><a href="#第四步构建成starter包">第四步：构建成<code>starter</code>包</a></li>
      </ul>
    </li>
    <li><a href="#总结">总结</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="背景">背景</h2>
<p>我们知道可以使用SpringBoot快速开发基于Spring框架的项目，由于围绕SpringBoot存在很多开箱即用的Starter依赖，是的我们在开发业务代码时候能够非常方便的、不需要过多关注框架的配置，而只需要关注业务即可。</p>
<p>例如我我想在SpringBoot项目中集成Redis，那么我只需要加入<code>spring-data-redis-starter</code>的依赖，并简单配置一下连接信息以及Jedis连接池就可以。这为我们省去了之前很多的配置操作。甚至有些功能的开启只需要在启动类或配置类上增加一个注释即可完成。</p>
<h2 id="原理">原理</h2>
<p>我们指定使用一个公用Starter的时候，只需要将相应的依赖添加到Maven的pom文件中即可，免去了自己需要引用很多的依赖包，并且SpringBoot会自动进行类的自动配置。</p>
<p>那么SpringBoot是如何知道要实例化哪些类并进行配置的？</p>
<ol>
<li>SpringBoot在启动时，会去依赖的Starter包中寻找 resouces/META-INF/spring.factories 文件，然后根据文件中配置的Jar包去扫描项目所依赖的Jar包，这类似于Java的SPI机制。</li>
<li>根据 spring.factories 配置加载 AutoConfigure 类。</li>
<li>根据@Conditional 注释的条件，进行自动配置并将Bean注入Spring Context 上下文当中。</li>
</ol>
<p>我们也可以使用 @ImportAutoConfiguration({MyServiceAutoConfigration.class})指定自动配置哪些类。</p>
<p>用过SPI机制的同学可能会清楚一个概念，当一个框架需要动态的扩展能力、给使用者充分的扩展能力，那么可能会使用到SPI机制。</p>
<blockquote>
<p>Java SPI 实际上是“基于接口的编程＋策略模式＋配置文件”组合实现的动态加载机制。</p>
</blockquote>
<h3 id="官方说明">官方说明</h3>
<blockquote>
<p>Spring Boot checks for the presence of a META-INF/spring.factories file within your published jar.</p>
<p>The file should list your configuration classes under the EnableAutoConfiguration key, as shown in the following example:</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-properties" data-lang="properties"><span class="line"><span class="cl"><span class="na">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span><span class="o">=</span><span class="s">\
</span></span></span><span class="line"><span class="cl"><span class="s">com.mycorp.libx.autoconfigure.LibXAutoConfiguration,\
</span></span></span><span class="line"><span class="cl"><span class="s">com.mycorp.libx.autoconfigure.LibXWebAutoConfiguration</span>
</span></span></code></pre></div><p>从上面的说明可以看出，只要我们在自己的Starter的META-INF/spring.factories中配置好AutoConfiguration，SpringBoot就可以检测并且加载。AutoConfiguration需要用到@Configuration 标识，代表它是一个配置类，并且结合 @Conditional 及相关注解灵活读取配置信息。</p>
<h3 id="conditional">@Conditional</h3>
<p>我们可以控制一个类满足某一条件才能进行实例化。在Spring中就有@Conditional注释和Condition接口，这个接口有一个matches方法，使用者可以重写这个方法。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestCondition</span> <span class="kd">implements</span> <span class="n">Condition</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">matches</span><span class="o">(</span><span class="n">ConditionContext</span> <span class="n">context</span><span class="o">,</span> <span class="n">AnnotatedTypeMetadata</span> <span class="n">metadata</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>我们就可以把@Conditional(value = TestCondition.class)标注在类上面，表示该类下面的所有@Bean都会启用配置。在<code>spring-boot-autoconfigure</code>中，SpringBoot官方实现了一系列Condition，用来方便平时开发，如下：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>@ConditionalOnBean</td>
<td>在BeanFactory已经存在指定Bean</td>
</tr>
<tr>
<td>@ConditionalOnMissingBean</td>
<td>在BeanFactory不存在指定Bean</td>
</tr>
<tr>
<td>@ConditionalOnClass</td>
<td>在classpath下已存在指定class</td>
</tr>
<tr>
<td>@ConditionalOnCloudPlatform</td>
<td>指定云平台已生效</td>
</tr>
<tr>
<td>@ConditionalOnExpression</td>
<td>指定SPEL表达式为true</td>
</tr>
<tr>
<td>@ConditionalOnJava</td>
<td>指定Java版本（前或后）</td>
</tr>
<tr>
<td>@ConditionalOnJndi</td>
<td>指定JNDI存在</td>
</tr>
<tr>
<td>@ConditionalOnNotWebApplication</td>
<td>非web应用</td>
</tr>
<tr>
<td>@ConditionalOnWebApplication</td>
<td>web环境</td>
</tr>
<tr>
<td>@ConditionalOnProperty</td>
<td>指定的property有指定的值</td>
</tr>
<tr>
<td>@ConditionalOnResource</td>
<td>在classpath下存在指定的资源</td>
</tr>
<tr>
<td>@ConditionalOnSingleCandidate</td>
<td>BeanFactory中该类型Bean只有一个或@Primary的只有一个</td>
</tr>
</tbody>
</table>
<h2 id="实现步骤">实现步骤</h2>
<h3 id="第一步命名与分模块">第一步：命名与分模块</h3>
<p>接下来我们开始编写我们自己的，SpringBoot官方推荐自定义<code>starter</code>以<code>xxx-spring-boot-starter</code>命名，并且分两个模块，<code>Autoconfigure模块</code>和<code>Starter模块</code>，主要配置在<code>Autoconfigure模块</code>，<code>Starter模块</code>其实是一个空项目模块。</p>
<p>首先在父项目的pom文件加入SpringBoot依赖</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml" data-lang="xml"><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-dependencies<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>${spring-boot.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;type&gt;</span>pom<span class="nt">&lt;/type&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;scope&gt;</span>import<span class="nt">&lt;/scope&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h3 id="starter模块">Starter模块</h3>
<p>Starter模块是个空模块，只有一个pom文件，目的就是提供必要的依赖项。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-XML" data-lang="XML"><span class="line"><span class="cl"><span class="nt">&lt;dependencies&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;groupId&gt;</span>me.mingshan<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;artifactId&gt;</span>demo-spring-boot-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependencies&gt;</span>
</span></span></code></pre></div><h3 id="第二步编写autoconfigure模块">第二步：编写AutoConfigure模块</h3>
<p>Autoconfigure模块加入依赖：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-XML" data-lang="XML"><span class="line"><span class="cl"><span class="c">&lt;!-- Compile dependencies --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>spring-boot-autoconfigure<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>spring-boot-configuration-processor<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;optional&gt;</span>true<span class="nt">&lt;/optional&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c">&lt;!-- 根据自己项目情况选择对应的依赖 --&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;dependency&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-aop<span class="nt">&lt;/artifactId&gt;</span>
</span></span><span class="line"><span class="cl"><span class="nt">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>其中 <code>spring-boot-configuration-processor</code> 主要是用来生成元数据文件（META-INF/spring-configuration-metadata.json）。如果存在该文件，那么SpringBoot会优先读取元数据文件，提供启动速度。</p>
<h3 id="自定义service">自定义Service</h3>
<p>例如我们想实现一个基于AOP切面实现的程序耗时日志打印Starter，本次我们可以选择使用@ConditionalOnProperty，即配置文件中有 <code>aspect.log.enable = true</code>，才加载我们的配置类。</p>
<h4 id="1定义aspectlog注释">1.定义AspectLog注释</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-Java" data-lang="Java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.ElementType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.Retention</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.RetentionPolicy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">java.lang.annotation.Target</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Target</span><span class="o">(</span><span class="n">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Retention</span><span class="o">(</span><span class="n">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="nd">@interface</span> <span class="n">AspectLog</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="2定义配置文件对应类">2.定义配置文件对应类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.boot.context.properties.ConfigurationProperties</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@ConfigurationProperties</span><span class="o">(</span><span class="s">&#34;aspect-log&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectLogProperties</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">enable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnable</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">enable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setEnable</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">enable</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">enable</span> <span class="o">=</span> <span class="n">enable</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="3定义自动配置类">3.定义自动配置类</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.ProceedingJoinPoint</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Around</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.aspectj.lang.annotation.Aspect</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.boot.autoconfigure.condition.*</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.context.annotation.EnableAspectJAutoProxy</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">org.springframework.core.PriorityOrdered</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Aspect</span>
</span></span><span class="line"><span class="cl"><span class="nd">@EnableAspectJAutoProxy</span><span class="o">(</span><span class="n">exposeProxy</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">proxyTargetClass</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="nd">@Configuration</span>
</span></span><span class="line"><span class="cl"><span class="nd">@ConditionalOnProperty</span><span class="o">(</span><span class="n">prefix</span> <span class="o">=</span> <span class="s">&#34;aspect-log&#34;</span><span class="o">,</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;enable&#34;</span><span class="o">,</span>
</span></span><span class="line"><span class="cl">                     <span class="n">havingValue</span> <span class="o">=</span> <span class="s">&#34;true&#34;</span><span class="o">,</span> <span class="n">matchIfMissing</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AspectLogAutoConfiguration</span> <span class="kd">implements</span> <span class="n">PriorityOrdered</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">protected</span> <span class="n">Logger</span> <span class="n">logger</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">getClass</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@Around</span><span class="o">(</span><span class="s">&#34;@annotation(com.xxx.aspect.log.AspectLog) &#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">isOpen</span><span class="o">(</span><span class="n">ProceedingJoinPoint</span> <span class="n">thisJoinPoint</span><span class="o">)</span> 
</span></span><span class="line"><span class="cl">                                        <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//执行方法名称 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">String</span> <span class="n">taskName</span> <span class="o">=</span> <span class="n">thisJoinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">            <span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">substring</span><span class="o">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">thisJoinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">()</span>
</span></span><span class="line"><span class="cl">                    <span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34; &#34;</span><span class="o">),</span> 
</span></span><span class="line"><span class="cl">                    <span class="n">thisJoinPoint</span><span class="o">.</span><span class="na">getSignature</span><span class="o">().</span><span class="na">toString</span><span class="o">().</span><span class="na">indexOf</span><span class="o">(</span><span class="s">&#34;(&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">taskName</span> <span class="o">=</span> <span class="n">taskName</span><span class="o">.</span><span class="na">trim</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">thisJoinPoint</span><span class="o">.</span><span class="na">proceed</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">logger</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">&#34;method:{} run :{} ms&#34;</span><span class="o">,</span> <span class="n">taskName</span><span class="o">,</span> 
</span></span><span class="line"><span class="cl">                            <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="n">time</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getOrder</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//保证事务等切面先执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h3 id="第三步配置springfactories">第三步：配置spring.factories</h3>
<p>META-INF/spring.factories是spring的工程机制，在这个文件中定义的类都会自动加载，多个配置使用逗号分割换行用<code>\</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">autoconfigure</span><span class="o">.</span><span class="na">EnableAutoConfiguration</span><span class="o">=</span><span class="err">\</span>
</span></span><span class="line"><span class="cl"><span class="n">com</span><span class="o">.</span><span class="na">shanyuan</span><span class="o">.</span><span class="na">autoconfiguration</span><span class="o">.</span><span class="na">aspectlog</span><span class="o">.</span><span class="na">AspectLogAutoConfiguration</span>
</span></span></code></pre></div><h3 id="第四步构建成starter包">第四步：构建成<code>starter</code>包</h3>
<p><code>mvn install</code> ，就可以进行测试验证了，自己的 Spring Boot Starter 开发完成了。</p>
<h2 id="总结">总结</h2>
<p>我们描述Starter的原理，以及如何开发一个Starter的步骤，简要说明了@Conditional的作用。</p>
<p>Stater原理的：</p>
<ol>
<li>Spring Boot在启动时扫码项目所依赖Jar包，寻找包含spring.factories文件的Jar包</li>
<li>根据spring.factories 配置加载AutoConfigure类</li>
<li>根据@Conditional 注解条件，进行自动配置并将Bean 注入Spring Context</li>
</ol>
<h4 id="demo">DEMO</h4>
<p>aspect-log-spring-boot (<a href="https://github.com/j5land/aspect-log-spring-boot"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/j5land/aspect-log-spring-boot</a>)</p>
<h2 id="references">References</h2>
<ul>
<li>Creating Your Own Starter (<a href="https://docs.spring.io/spring-boot/docs/2.1.6.RELEASE/reference/html/boot-features-developing-auto-configuration.html#boot-features-custom-starter"target="_blank" rel="external nofollow noopener noreferrer">https://docs.spring.io/spring-boot/docs/2.1.6.RELEASE/reference/html/boot-features-developing-auto-configuration.html#boot-features-custom-starter</a>)</li>
<li>编写一个自己的SpringBoot Starter (<a href="https://mingshan.fun/2019/06/26/boot-features-custom-starter/"target="_blank" rel="external nofollow noopener noreferrer">https://mingshan.fun/2019/06/26/boot-features-custom-starter/</a>)</li>
<li>MyBatis Stater源码阅读 (<a href="https://github.com/mybatis/spring-boot-starter"target="_blank" rel="external nofollow noopener noreferrer">https://github.com/mybatis/spring-boot-starter</a>)</li>
</ul>
</div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title=2022-06-12&#32;14:10:04>更新于 2022-06-12&nbsp;</span>
      </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span></span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/java/' class="post-tag">Java</a><a href='/tags/springboot/' class="post-tag">SpringBoot</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/springboot%E7%9A%84%E5%89%8D%E4%B8%96%E4%BB%8A%E7%94%9F/" class="post-nav-item" rel="prev" title="SpringBoot的前世今生"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>SpringBoot的前世今生</a>
      <a href="/posts/mysql%E4%BA%8B%E5%8A%A1%E4%B8%8Espring%E4%BA%8B%E5%8A%A1%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/" class="post-nav-item" rel="next" title="MySQL事务与Spring事务传递机制">MySQL事务与Spring事务传递机制<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<div id="comments"><div id="giscus">
          <script
            src="https://giscus.app/client.js"
            data-repo="j5land/j5land.github.io"
            data-repo-id="MDEwOlJlcG9zaXRvcnkxNjYxNTcwMjc="
            data-category="General"
            data-category-id="DIC_kwDOCeda484CUFrI"
            data-mapping="title"
            
            data-theme="preferred_color_scheme"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-lang="zh-CN"
            data-loading="lazy"
            crossorigin="anonymous"
            async
            defer
          ></script>
        </div>
        <noscript>
          Please enable JavaScript to view the comments powered by <a href="https://giscus.app/" rel="external nofollow noopener noreferrer">giscus</a>.
        </noscript></div></article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">Copyright © J5land Blog 2023
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2023</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div><div class="footer-line statistics"><span class="site-time" title='网站运行中 ...'><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden="true"></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中 ...</span></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div><div class="fixed-button view-comments d-none" role="button" aria-label="查看评论"><i class="fa-solid fa-comment fa-fw" aria-hidden="true"></i></div></div><div id="mask"></div><div class="reading-progress-bar" style="left: 0;top: 0;"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/fuse/fuse.min.js" defer></script><script src="/lib/lazysizes/lazysizes.min.js" async defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":true,"expired":false,"giscus":{"darkTheme":"dark","lightTheme":"light"}},"search":{"distance":100,"findAllMatches":false,"highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":30,"threshold":0.3,"useExtendedSearch":false},"siteTime":"2020-05-23T16:15:22+08:00"};</script><script src="/js/theme.min.js" defer></script></body>
</html>
